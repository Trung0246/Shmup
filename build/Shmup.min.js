!function(a){"use strict";function j(a,b){a=g[a.type].draw(a),e.actions(a.actionRef,b,a.commands[a.commands.length-1].actions,a.commands,void 0,a)}function k(){return(1e36*Math.random()).toString(36)}function l(a,b){if("function"==typeof a)return b?a:l(a());if("number"==typeof a||"boolean"==typeof a||"object"==typeof a){if(!Number.isNaN(a)||Array.isArray(a)||a instanceof Object)return a;throw new Error("Invalid data")}if("string"==typeof a)return Number.isNaN(a)||b?a:Number(a);throw new Error("Invalid data")}function m(a){return c[h].configs.angleType||(c[h].configs.angleType="degree"),"degree"===l(c[h].configs.angleType,!0)?Math.degToRad(Math.normalizeDegree(a)):"radian"===l(c[h].configs.angleType,!0)?Math.normalizeRadian(a):void 0}function n(a,b){return"degree"!==c[h].configs.angleType&&c[h].configs.angleType?"radian"===c[h].configs.angleType?-Math.atan2(a[0]-b[0],-(a[1]-b[1])):void 0:Math.radToDeg(-Math.atan2(a[0]-b[0],-(a[1]-b[1])))}var h,i,c={},d={},e={},f={},g={};return d.configs=function(a){return c[h].configs=a,this},d.actions=function(a,b,d){return c[h].actions||(c[h].actions={}),b?(c[h].actions.fire||(c[h].actions.fire={}),c[h].actions.fire[a]||(c[h].actions.fire[a]=d)):(c[h].actions.ref||(c[h].actions.ref={}),c[h].actions.ref[a]||(c[h].actions.ref[a]=d)),f[h].bullets||(f[h].bullets={}),!f[h].bullets[a]&&b&&(f[h].bullets[a]={}),f[h].fire||(f[h].fire={}),f[h].fire[a]||(f[h].fire[a]={}),f[h].commands||(f[h].commands={}),f[h].commands[a]||(f[h].commands[a]=[{location:0,times:1,actions:d,label:a}]),f[h].timeOut||(f[h].timeOut={}),f[h].timeOut[a]||(f[h].timeOut[a]={}),b&&(f[h].isFiring||(f[h].isFiring={}),f[h].isFiring[a]||(f[h].isFiring[a]=!1)),this},d.fire=function(a){if(f[h].isFiring[a]===!1&&(f[h].isFiring[a]=!0),!c[h].actions.fire[a])throw new Error("Undefined actions of "+a);e.actions(a,a,f[h].commands[a][f[h].commands[a].length-1].actions,f[h].commands[a],void 0,void 0)},d.update=function(){for(var a in c[h].actions.fire){f[h].isFiring[a]===!0&&(f[h].timeOut[a].times>0&&f[h].timeOut[a].times--,(f[h].timeOut[a].times<=0||void 0===f[h].timeOut[a].times)&&(f[h].timeOut[a].times<=0&&(f[h].timeOut[a].times=void 0),e.actions(a,a,f[h].commands[a][f[h].commands[a].length-1].actions,f[h].commands[a],void 0,void 0)));for(var b in f[h].bullets[a]){for(var d=f[h].bullets[a][b],i=0;i<d.length;i++)!function(){var j=f[h].bullets[a][b][i];if(null!==j&&(j=g[c[h].configs.shot[j.type].type].draw(j),j.count=i,j.actionRef&&(j.wait.times>0&&j.wait.times--,(j.wait.times<=0||void 0===j.wait.times)&&(j.wait.times<=0&&(j.wait.times=void 0),j.commands.length>0&&e.actions(j.actionRef,a,j.commands[j.commands.length-1].actions,j.commands,void 0,j))),c[h].configs.shot[j.type].draw(j),c[h].configs.shot[j.type].callback)){var k=c[h].configs.shot[j.type].callback(j.actionRef||a,a,function(){try{return j.commands[j.commands.length-1].actions}catch(a){return}}(),j.commands,void 0,j);switch(k){case"vanish":g[c[h].configs.shot[j.type].type].vanish(j.actionRef,a,void 0,void 0,{type:"current"},j)}}}();if(d.indexOf(null)>-1)for(var j=d.length-1;j>=0;--j)null===d[j]&&d.splice(j,1)}}},e.actions=function(a,b,c,d,g,i){var k=[{location:0,times:1,actions:c,label:a}];a===b?d||(d=k):a!==b&&(i.commands||(i.commands=k,d=i.commands));var l;!function g(){for(;d[d.length-1].times>0;){for(;d[d.length-1].location<c.length;){if(l=e[c[d[d.length-1].location].func](a,b,c,d,c[d[d.length-1].location],i),"string"==typeof l)return;"object"==typeof l&&l.actionRef&&j(l,b),d[d.length-1].location++}d[d.length-1].location=0,d[d.length-1].times--}try{if(d.pop(),d.length<=1)return void(a===b&&(f[h].isFiring[a]=!1));c=d[d.length-1].actions,g()}catch(a){}}(),"repeat"===l&&e.actions(a,b,d[d.length-1].actions,d,g,i)},e.repeat=function(a,b,c,d,e,f){return e.label||(e.label=k()),d.push({actions:c[d[d.length-1].location].actions,location:0,times:e.times,label:e.label||function(){var a=k();return e.label=a,a}()}),d[d.length-2].location++,"repeat"},e.wait=function(a,b,c,d,e,g){return e.label||(e.label=k()),a===b?(f[h].timeOut[a].label=e.label,f[h].timeOut[a].times=e.times):a!==b&&(g.wait.label=e.label,g.wait.times=e.times),d[d.length-1].location++,"wait"},e.fire=function(a,b,d,e,f,i){g[c[h].configs.shot[f.type].type].fire(a,b,d,e,f,i)},e.vanish=function(a,b,d,e,f,i){g[c[h].configs.shot[i.type].type].vanish(a,b,d,e,f,i)},e.change=function(a,b,d,e,f,i){g[c[h].configs.shot[i.type].type].change(a,b,d,e,f,i)},e.func=function(a,b,c,d,e,f){e.callback(a,b,c,d,e,f)},g.bullet={fire:function(a,b,d,e,g,i){g.label||(g.label=k()),f[h].bullets[b][g.label]||(f[h].bullets[b][g.label]=[]),f[h].fire[a][g.label]||(f[h].fire[a][g.label]={direction:void 0,speed:{horizontal:0,vertical:0}});var j={type:g.type,label:g.label,position:{now:void 0},wait:{},flag:k(),count:0};if(g.actionRef&&(j.actionRef=g.actionRef,j.commands=[{location:0,times:1,actions:c[h].actions.ref[g.actionRef],label:a}]),g.movement)j.movement=g.movement;else{if(g.position||(g.position={}),g.position.now?j.position.now=g.position.now.slice():i?j.position.now=i.position.now.slice():j.position.now=c[h].configs.position(),g.position.end)j.position.end=g.position.end,j.direction.value=n(j.position.now,j.position.end);else{if(!g.direction)throw new Error("Invalid fire direction");switch(j.direction||(j.direction={}),g.direction.type){case"aim":j.direction.value=n(j.position.now,c[h].configs.target())+(g.direction.value||0);break;case"absolute":j.direction.value=g.direction.value;break;case"sequence":f[h].fire[a][g.label].direction&&"number"==typeof f[h].fire[a][g.label].direction?"number"==typeof f[h].fire[a][g.label].direction&&(f[h].fire[a][g.label].direction+=g.direction.value):f[h].fire[a][g.label].direction=g.direction.value,j.direction.value=f[h].fire[a][g.label].direction;break;case"relative":if(!c[h].actions.ref[a])throw new Error("Relative must be use in actionRef");j.direction.value=g.direction.value,j.direction.value+=i.direction.value;break;default:j.direction.value=0}}if(!g.speed)throw new Error("Invalid fire speed");switch(j.speed||(j.speed={}),g.speed.horizontal.type){case"absolute":j.speed.horizontal=g.speed.horizontal.value;break;case"sequence":f[h].fire[a][g.label].speed.horizontal&&"number"==typeof f[h].fire[a][g.label].speed.horizontal?"number"==typeof f[h].fire[a][g.label].speed.horizontal&&(f[h].fire[a][g.label].speed.horizontal+=g.speed.horizontal.value):f[h].fire[a][g.label].speed.horizontal=g.speed.horizontal.value,j.speed.horizontal=f[h].fire[a][g.label].speed.horizontal;break;case"relative":if(!c[h].actions.ref[a])throw new Error("Relative must be use in actionRef");j.speed.horizontal=g.speed.horizontal.value,j.speed.horizontal+=i.speed.horizontal.value;break;default:j.speed.horizontal=1}switch(g.speed.vertical.type){case"absolute":j.speed.vertical=g.speed.vertical.value;break;case"sequence":f[h].fire[a][g.label].speed.vertical&&"number"==typeof f[h].fire[a][g.label].speed.vertical?"number"==typeof f[h].fire[a][g.label].speed.vertical&&(f[h].fire[a][g.label].speed.vertical+=g.speed.vertical.value):f[h].fire[a][g.label].speed.vertical=g.speed.vertical.value,j.speed.vertical=f[h].fire[a][g.label].speed.vertical;break;case"relative":if(!c[h].actions.ref[a])throw new Error("Relative must be use in actionRef");j.speed.vertical=g.speed.vertical.value,j.speed.vertical+=i.speed.vertical.value;break;default:j.speed.vertical=1}}return f[h].bullets[b][g.label].push(j),j=f[h].bullets[b][g.label][f[h].bullets[b][g.label].length-1]},draw:function(a){return a.change&&(a.change.direction&&a.change.direction.times>0&&("plus"===a.change.direction.type?a.direction.value+=a.change.direction.change:"multiply"===a.change.direction.type&&(a.direction.value*=a.change.direction.change),a.change.direction.times--),a.change.speed&&(a.change.speed.horizontal&&a.change.speed.horizontal.times>0&&("plus"===a.change.speed.horizontal.type?a.speed.horizontal+=a.change.speed.horizontal.change:"multiply"===a.change.speed.horizontal.type&&(a.speed.horizontal*=a.change.speed.horizontal.change),a.change.speed.horizontal.times--),a.change.speed.vertical&&a.change.speed.vertical.times>0&&("plus"===a.change.speed.vertical.type?a.speed.vertical+=a.change.speed.vertical.change:"multiply"===a.change.speed.vertical.type&&(a.speed.vertical*=a.change.speed.vertical.change),a.change.speed.vertical.times--))),"function"==typeof a.movement?a.position.now=a.movement():(a.position.now[0]=Math.sin(m(a.direction.value))*a.speed.horizontal+a.position.now[0],a.position.now[1]=Math.cos(m(a.direction.value))*a.speed.vertical+a.position.now[1]),a},change:function(a,b,d,e,f,g){if(!c[h].actions.ref[a])throw new Error("Change must be called in not fire actions");g.change||(g.change={}),f.movement?g.movement=f.movement:(f.position||(f.position={}),f.position.now&&(g.position.now=f.position.now.slice()),f.position.end?(g.change.direction||(g.change.direction={}),g.position.end=f.position.end.slice(),g.change.direction.times=f.position.times||1,g.change.direction.value=n(g.position.now,f.position.end),g.change.direction.type="plus",g.change.direction.change=(g.change.direction.value-g.direction.value)/g.change.direction.times):f.direction&&(f.direction||(f.direction={}),g.change.direction||(g.change.direction={}),g.change.direction.value=f.direction.value||0,f.direction.type?g.change.direction.type=f.direction.type:f.direction.velocity?g.change.direction.type="multiply":g.change.direction.type="plus",g.change.direction.times=f.direction.times||1,"plus"===g.change.direction.type?g.change.direction.change=g.change.direction.value/g.change.direction.times:"multiply"===g.change.direction.type&&(g.change.direction.change=g.change.direction.value)),f.speed&&(g.change.speed||(g.change.speed={}),f.speed.horizontal&&(g.change.speed.horizontal||(g.change.speed.horizontal={}),g.change.speed.horizontal.value=f.speed.horizontal.value||0,f.speed.horizontal.type?g.change.speed.horizontal.type=f.speed.horizontal.type:f.speed.horizontal.velocity?g.change.speed.horizontal.type="multiply":g.change.speed.horizontal.type="plus",g.change.speed.horizontal.times=f.speed.horizontal.times||1,"plus"===g.change.speed.horizontal.type?g.change.speed.horizontal.change=(g.change.speed.horizontal.value-g.speed.horizontal)/g.change.speed.horizontal.times:"multiply"===g.change.speed.horizontal.type&&(g.change.speed.horizontal.change=g.change.speed.horizontal.value)),f.speed.vertical&&(g.change.speed.vertical||(g.change.speed.vertical={}),g.change.speed.vertical.value=f.speed.vertical.value||0,f.speed.vertical.type?g.change.speed.vertical.type=f.speed.vertical.type:f.speed.vertical.velocity?g.change.speed.vertical.type="multiply":g.change.speed.vertical.type="plus",g.change.speed.vertical.times=f.speed.vertical.times||1,"plus"===g.change.speed.vertical.type?g.change.speed.vertical.change=(g.change.speed.vertical.value-g.speed.vertical)/g.change.speed.vertical.times:"multiply"===g.change.speed.vertical.type&&(g.change.speed.vertical.change=g.change.speed.vertical.value))))},vanish:function(a,b,d,e,g,i){var j=f[h].bullets[b][function(){if("current"===g.type){if(i)return i.label;throw new Error("Current must use in actionRef")}if(g.label)return g.label;if(i)return i.label;throw new Error("Label didn't defined")}()],k=0,l=j.length-1;switch(g.type){case"current":c[h].configs.shot[i.type].vanish(j[i.count]),j[i.count]=null;break;case"first":for(k=0;k<g.value;k++)c[h].configs.shot[i.type].vanish(j[k]),j[k]=null;break;case"last":for(k=0;k<g.value;k++)c[h].configs.shot[i.type].vanish(j[l]),j[l]=null,l--;break;case"random":for(k=0;k<g.value;k++)!function a(){l=Math.floor(Math.random()*j.length),null===j[l]?a():(c[h].configs.shot[i.type].vanish(j[l]),j[l]=null)}();break;default:var m=i.type;for(k=0;k<j.length;k++)c[h].configs.shot[m].vanish(j[k]),j[k]=null}}},Math.normalizeRadian=function(a){for(a%=2*Math.PI;a<=-Math.PI;)a+=2*Math.PI;for(;Math.PI<a;)a-=2*Math.PI;return a},Math.normalizeDegree=function(a){for(a%=360;a<=0;)a+=360;for(;180<a;)a-=360;return a},Math.pythagoreanPos=function(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2))},Math.radToDeg=function(a){return a%=2*Math.PI,a*(180/Math.PI)},Math.degToRad=function(a){return a%=360,a*(Math.PI/180)},i=function(a){return h=a,c[h]||(c[h]={}),f[h]||(f[h]={}),d},"function"==typeof define&&define.amd?void define(function(){return i}):"undefined"!=typeof module&&module.exports?void(module.exports=i):void(a.Shmup=i)}("undefined"!=typeof window?window:{});
